#!/usr/bin/env python
# GENERATED BY INSIGHT-PLUGIN - DO NOT EDIT
import os
import json
from sys import argv

Name = "Microsoft Defender for Endpoint"
Vendor = "rapid7"
Version = "6.0.3"
Description = "The Microsoft Defender for Endpoint plugin allows Rapid7 InsightConnect users to quickly take remediation actions across their organization. This plugin can isolate machines, run virus scans, and quarantine files"


def main():
    if 'http' in argv:
        if os.environ.get("GUNICORN_CONFIG_FILE"):
            with open(os.environ.get("GUNICORN_CONFIG_FILE")) as gf:
                gunicorn_cfg = json.load(gf)
                if gunicorn_cfg.get("worker_class", "sync") == "gevent":
                    from gevent import monkey
                    monkey.patch_all()
        elif 'gevent' in argv:
            from gevent import monkey
            monkey.patch_all()

    import insightconnect_plugin_runtime
    from komand_microsoft_atp import connection, actions, triggers, tasks

    class ICONMicrosoftAtp(insightconnect_plugin_runtime.Plugin):
        def __init__(self):
            super(self.__class__, self).__init__(
                name=Name,
                vendor=Vendor,
                version=Version,
                description=Description,
                connection=connection.Connection()
            )
            self.add_trigger(triggers.GetAlertMatchingKey())
        
            self.add_trigger(triggers.GetAlerts())
        
            self.add_action(actions.GetMachineInformation())
        
            self.add_action(actions.GetFileIdFromAlertId())
        
            self.add_action(actions.IsolateMachine())
        
            self.add_action(actions.UnisolateMachine())
        
            self.add_action(actions.StopAndQuarantineFile())
        
            self.add_action(actions.RunAntivirusScan())
        
            self.add_action(actions.GetMachineAction())
        
            self.add_action(actions.FindMachinesWithInstalledSoftware())
        
            self.add_action(actions.Blacklist())
        
            self.add_action(actions.GetMachineVulnerabilities())
        
            self.add_action(actions.GetSecurityRecommendations())
        
            self.add_action(actions.GetMissingSoftwareUpdates())
        
            self.add_action(actions.GetInstalledSoftware())
        
            self.add_action(actions.ManageTags())
        
            self.add_action(actions.GetRelatedMachines())
        
            self.add_action(actions.CollectInvestigationPackage())
        
            self.add_action(actions.UpdateAlert())
        

    """Run plugin"""
    cli = insightconnect_plugin_runtime.CLI(ICONMicrosoftAtp())
    cli.run()


if __name__ == "__main__":
    main()
