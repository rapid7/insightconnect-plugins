# Description

[Carbon Black Defense](https://www.carbonblack.com/products/cb-defense/) is a next-generation antivirus and EDR in one cloud-delivered platform.
This plugin utilizes the [Carbon Black Defense API](https://developer.carbonblack.com/reference/cb-defense/1/rest-api/).

# Key Features

* Feature 1
* Feature 2
* Feature 3

# Requirements

* Example: Requires an API Key from the product
* Example: API must be enabled on the Settings page in the product

# Documentation

## Setup

The connection configuration accepts the following parameters:

|Name|Type|Default|Required|Description|Enum|
|----|----|-------|--------|-----------|----|
|url|string|https\://api.confer.net|True|API URL|None|
|connector|string|None|True|Connector ID|None|
|api_key|credential_secret_key|None|True|API key|None|

## Technical Details

### Actions

#### Find Event

This action is used to retrieve all events matching the input search criteria. Response contains a list of events in JSON format. Resulting events are sorted in descending order of time.

##### Input

|Name|Type|Default|Required|Description|Enum|
|----|----|-------|--------|-----------|----|
|applicationName|string|None|False|Filter on events generated by a process with the given application name (for example, googleupdate.exe. Note that this name must be lowercase)|None|
|eventType|string|None|False|Filter on events with a given event type|['', 'NETWORK', 'FILE_CREATE', 'REGISTRY_ACCESS', 'SYSTEM_API_CALL', 'CREATE_PROCESS', 'DATA_ACCESS', 'INJECT_CODE']|
|hostName|string|None|False|Filter on hostnames case insensitive. For example hostName=win-IA9NQ1GN8OI will match the hostname WIN-IA9NQ1GN8OI|None|
|hostNameExact|string|None|False|Filter on the exact hostname. For example hostName=WIN-IA9NQ1GN8OI will only return devices with the exact hostname WIN-IA9NQ1GN8OI but not a host named win-IA9NQ1GN8OI|None|
|ownerNameExact|string|None|False|Same as 'Owners Name' but with case sensitivity|None|
|ownerName|string|None|False|Filter on owner name case insensitive|None|
|sha256hash|string|None|False|Filter on events generated by a process with the given SHA-256 hash. Note that this hash must be lowercase|None|
|searchWindow|string|None|False|Filter on events generated within a given relative time frame. Note that the default is one day if a searchWindow is not specified. Note that events may not be available past 30 days due to retention policies e.g. 4d, 2w|None|
|ipAddress|string|None|False|Filter on events generated by a device with a given external or internal IP address|None|

##### Output

|Name|Type|Required|Description|
|----|----|--------|-----------|
|success|boolean|False|Success|
|totalResults|integer|False|Total Results|
|message|string|False|Message|
|latestTime|integer|False|Latest Time|
|results|[]results|False|Results|
|elapsed|integer|False|Elapsed|

Example output:

```
{
  "success": true,
  "latestTime": 0,
  "results": [
    {
      "eventId": "1defe38112e911e7b34047d6447797bd",
      "processDetails": {
        "userName": "SYSTEM",
        "processId": 2872,
        "milisSinceProcessStart": 32,
        "name": "taskeng.exe",
        "parentPid": 772,
        "interpreterHash": null,
        "interpreterName": null,
        "commandLine": "taskeng.exe {5267BC82-9B0D-4F0B-A566-E06CDE5602F1} S-1-5-18:NT AUTHORITY\\System:Service:",
        "parentName": "svchost.exe",
        "parentPrivatePid": "772-1489763380982-18",
        "targetPid": 2468,
        "targetPrivatePid": "2468-1490617768051-975",
        "parentCommandLine": "C:\\Windows\\system32\\svchost.exe -k netsvcs",
        "targetCommandLine": "C:\\Program Files (x86)\\Google\\Update\\GoogleUpdate.exe",
        "privatePid": "2872-1490617768004-974",
        "targetName": "GoogleUpdate.exe",
        "fullUserName": "NT AUTHORITY\\SYSTEM"
      },
      "eventTime": 1490617768036,
      "selectedApp": {
        "applicationName": "taskeng.exe",
        "virusName": null,
        "reputationProperty": "TRUSTED_WHITE_LIST",
        "effectiveReputation": null,
        "applicationPath": "C:\\Windows\\System32\\taskeng.exe",
        "md5Hash": "a21ac8d41e63cf1aa24ebc165ae82c9a",
        "effectiveReputationSource": null,
        "virusCategory": null,
        "sha256Hash": "74b9cf472d5008e00735482f084f886eaa201248d6e87ab6b1990e3670bd6693",
        "virusSubCategory": null
      },
      "attackStage": null,
      "targetApp": {
        "applicationName": "C:\\Program Files (x86)\\Google\\Update\\GoogleUpdate.exe",
        "virusName": null,
        "reputationProperty": "TRUSTED_WHITE_LIST",
        "effectiveReputation": null,
        "applicationPath": null,
        "md5Hash": null,
        "effectiveReputationSource": null,
        "virusCategory": null,
        "sha256Hash": "52fc3aa9f704300041e486e57fe863218e4cdf4c8eee05ca6b99a296efee5737",
        "virusSubCategory": null
      },
      "registryValue": null,
      "alertCategory": null,
      "longDescription": "The application \"<share><link hash=\"74b9cf472d5008e00735482f084f886eaa201248d6e87ab6b1990e3670bd6693\">C:\\Windows\\System32\\taskeng.exe</link></share>\" attempted to invoke the application \"C:\\Program Files (x86)\\Google\\Update\\GoogleUpdate.exe\", by calling the function \"CreateProcessW\". The operation was successful.",
      "threatIndicators": [
        "SUSPENDED_PROCESS"
      ],
      "securityEventCode": null,
      "deviceDetails": {
        "deviceName": "WIN-EK5MJ5DQC3Q",
        "agentLocation": "OFFSITE",
        "targetPriorityCode": 2,
        "deviceOwnerName": null,
        "deviceIpAddress": "1.2.3.4",
        "deviceHostName": "example.com",
        "email": "Administrator",
        "groupName": "Restrictive_Windows_Workstation",
        "deviceType": "WINDOWS",
        "deviceId": 218616,
        "targetPriorityType": "HIGH",
        "deviceIpV4Address": "1.2.3.4",
        "deviceLocation": {
          "city": "Ashburn",
          "countryCode": "US",
          "areaCode": 703,
          "metroCode": 123,
          "region": "VA",
          "dmaCode": 123,
          "countryName": "United States",
          "postalCode": "20148",
          "longitude": -77.487442,
          "latitude": 39.043757
        },
        "deviceVersion": "Server 2012 R2 x64 "
      },
      "eventType": "SYSTEM_API_CALL",
      "netFlow": {
        "service": null,
        "peerSiteReputation": null,
        "peerIpAddress": null,
        "destPort": null,
        "sourcePort": null,
        "peerFqdn": null,
        "destAddress": null,
        "peerIpV4Address": null,
        "sourceAddress": null,
        "peerLocation": null
      },
      "incidentId": null,
      "shortDescription": "The application \"<share><link hash=\"74b9cf472d5008e00735482f084f886eaa201248d6e87ab6b1990e3670bd6693\">taskeng.exe</link></share>\" successfully attempted to invoke the application \"C:\\Program Files (x86)\\Google\\Update\\GoogleUpdate.exe\".",
      "createTime": 1490617872232,
      "alertScore": 0,
      "parentApp": {
        "applicationName": "C:\\Windows\\System32\\svchost.exe",
        "virusName": null,
        "reputationProperty": null,
        "effectiveReputation": null,
        "applicationPath": null,
        "md5Hash": null,
        "effectiveReputationSource": null,
        "virusCategory": null,
        "sha256Hash": "c7db4ae8175c33a47baa3ddfa089fad17bc8e362f21e835d78ab22c9231fe370",
        "virusSubCategory": null
      }
    }
  ],
  "elapsed": 3,
  "message": "Success",
  "totalResults": 28
}
```

#### Get Details for Specific Event

This action is used to retrieve details for an individual event given the event ID.

##### Input

|Name|Type|Default|Required|Description|Enum|
|----|----|-------|--------|-----------|----|
|event_id|string|None|True|Event ID|None|

##### Output

|Name|Type|Required|Description|
|----|----|--------|-----------|
|success|boolean|False|Success|
|message|string|False|Message|
|eventinfo|eventInfo|False|Detailed information on the event|

Example output:

```
{
  "success": true,
  "message": "Success",
  "eventinfo": {
    "shortDescription": "The application \"<share><link hash=\"9e70685b73b3eab78c55863babceecc7cca89475b508b2a9c651ade6fde0751a\">taskeng.exe</link></share>\" successfully attempted to invoke the application \"C:\\Program Files\\Google\\Update\\GoogleUpdate.exe\".",
    "longDescription": "The application \"<share><link hash=\"9e70685b73b3eab78c55863babceecc7cca89475b508b2a9c651ade6fde0751a\">C:\\Windows\\System32\\taskeng.exe</link></share>\" attempted to invoke the application \"C:\\Program Files\\Google\\Update\\GoogleUpdate.exe\", by calling the function \"CreateProcessW\". The operation was successful.",
    "eventTime": 1548878769180,
    "eventId": "8a57e38b24ca11e9ae3ab1dc32845eba",
    "netFlow": {},
    "createTime": 1548878809327,
    "threatIndicators": [
      "SUSPENDED_PROCESS"
    ],
    "deviceDetails": {
      "deviceIpAddress": "180.179.136.50",
      "agentLocation": "OFFSITE",
      "deviceLocation": {
        "city": "Mumbai",
        "region": "16",
        "areaCode": 0,
        "countryName": "India",
        "countryCode": "IN",
        "dmaCode": 0,
        "latitude": 18.972107,
        "longitude": 72.8246,
        "metroCode": 0,
        "postalCode": "400010"
      },
      "deviceIpV4Address": "180.179.136.50",
      "deviceType": "WINDOWS",
      "email": "Smokescreen-PC\\Smokescreen",
      "deviceId": 1155127,
      "deviceName": "Smokescreen-PC",
      "policyId": 6525,
      "deviceVersion": "Windows 7 x86 SP: 1",
      "targetPriorityType": "MEDIUM",
      "targetPriorityCode": 1,
      "policyName": "default"
    },
    "processDetails": {
      "targetName": "GoogleUpdate.exe",
      "fullUserName": "NT AUTHORITY\\SYSTEM",
      "userName": "SYSTEM",
      "parentName": "svchost.exe",
      "privatePid": "2912-1548878769008-846",
      "targetPrivatePid": "1088-1548878769164-848",
      "commandLine": "taskeng.exe {C6E24162-53E3-4116-85C3-452978163C7A} S-1-5-18:NT AUTHORITY\\System:Service:",
      "milisSinceProcessStart": 172,
      "processId": 2912,
      "parentPid": 940,
      "parentCommandLine": "C:\\Windows\\system32\\svchost.exe -k netsvcs",
      "targetCommandLine": "GoogleUpdate.exe",
      "targetPid": 1088,
      "parentPrivatePid": "940-1548747298649-32",
      "name": "taskeng.exe"
    },
    "eventType": "SYSTEM_API_CALL",
    "selectedApp": {
      "reputationProperty": "TRUSTED_WHITE_LIST",
      "applicationName": "taskeng.exe",
      "md5Hash": "4f2659160afcca990305816946f69407",
      "sha256Hash": "9e70685b73b3eab78c55863babceecc7cca89475b508b2a9c651ade6fde0751a",
      "applicationPath": "C:\\Windows\\System32\\taskeng.exe",
      "effectiveReputationSource": "WHITE_DATABASE",
      "effectiveReputation": "TRUSTED_WHITE_LIST"
    },
    "targetApp": {
      "reputationProperty": "TRUSTED_WHITE_LIST",
      "applicationName": "GoogleUpdate.exe",
      "sha256Hash": "542294724926b0e156224b9ebd33e6354d79da4c828fb52f7f4233df45e3f624",
      "effectiveReputationSource": "CLOUD",
      "effectiveReputation": "TRUSTED_WHITE_LIST"
    },
    "parentApp": {
      "reputationProperty": "TRUSTED_WHITE_LIST",
      "applicationName": "svchost.exe",
      "sha256Hash": "121118a0f5e0e8c933efd28c9901e54e42792619a8a3a6d11e1f0025a7324bc2",
      "effectiveReputationSource": "WHITE_DATABASE",
      "effectiveReputation": "TRUSTED_WHITE_LIST"
    },
    "alertScore": 0
  }
}
```

### Triggers

#### Get Notifications

This trigger is used to allows consumers to get alert and policy action notifications that a connector is subscribed to. Only API keys of type 'SIEM' can call the notifications API.

##### Input

|Name|Type|Default|Required|Description|Enum|
|----|----|-------|--------|-----------|----|
|frequency|integer|10|True|How often to poll for new notifications requests, in seconds|None|

##### Output

|Name|Type|Required|Description|
|----|----|--------|-----------|
|notifications|[]notifications|False|Collection of Notifincations|
|message|string|False|Notification Message|
|success|boolean|False|Notification Success|

### Custom Output Types

_This plugin does not contain any custom output types._

## Troubleshooting

When selecting adjusting frequency please review [rate limits](https://developer.carbonblack.com/reference/cb-defense/authentication/#rate-limiting)
Get Notifications trigger requiers that the [API key type](https://developer.carbonblack.com/reference/cb-defense/authentication/#api-key-types) is a 'SIEM' type

# Version History

* 1.1.1 - Update to Python 3.7 Slim SDK (plugin size reduction) | Fix bug in output where Security Event Code was defined as an `object` instead of a `string`
* 1.1.0 - New action Get Details for Specific Event
* 1.0.0 - Update to v2 Python plugin architecture | Support web server mode | Update to new credential types
* 0.1.0 - Initial plugin

# Links

## Source Code

https://github.com/rapid7/insightconnect-plugins

## References

* [Carbon Black Defense](https://www.carbonblack.com/products/cb-defense/)
* [Carbon Black Defense API](https://developer.carbonblack.com/reference/cb-defense/1/rest-api/)
* [Rate Limits](https://developer.carbonblack.com/reference/cb-defense/authentication/#rate-limiting)
* [API Key Types](https://developer.carbonblack.com/reference/cb-defense/authentication/#api-key-types)

